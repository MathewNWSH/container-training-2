apiVersion: v1
kind: ConfigMap
metadata:
  name: locust-script
  namespace: locust
data:
  locustfile.py: |
    from locust import HttpUser, task, between

    class MapServerUser(HttpUser):
        wait_time = between(0.5, 2)

        @task
        def get_map(self):
            # Parametry z Twojego URL
            wms_params = (
                "/mapserver?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap"
                "&BBOX=2914994.568592441268,4969954.361772307195,3129956.172707903199,5152659.413609274663"
                "&CRS=EPSG:3035&WIDTH=1484&HEIGHT=1748"
                "&LAYERS=URBAN_ATLAS_COG&STYLES=&FORMAT=image/png"
                "&DPI=192&MAP_RESOLUTION=192&FORMAT_OPTIONS=dpi:192&TRANSPARENT=TRUE"
            )
            self.client.get(wms_params)

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: locust
  namespace: locust
spec:
  replicas: 1
  selector:
    matchLabels:
      app: locust
  template:
    metadata:
      labels:
        app: locust
    spec:
      containers:
      - name: locust
        image: locustio/locust:latest
        ports:
        - containerPort: 8089
        env:
        - name: LOCUST_LOCUSTFILE
          value: "/mnt/locust/locustfile.py"
        - name: LOCUST_HOST
          value: "http://mapserver.mapserver.svc.cluster.local" # WewnÄ™trzny adres K8s do MapServera
        volumeMounts:
        - name: locust-script
          mountPath: /mnt/locust
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 512Mi
      volumes:
      - name: locust-script
        configMap:
          name: locust-script
